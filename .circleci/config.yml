version: 2.1

workflows:
  version: 2
  main_workflow:
    jobs:
      - test:
          # `filters` is required since `deploy` has tag filters AND requires `test`
          filters: &default_filters
            tags:
              only: /.*/
            branches:
              only: /.*/
      - build:
          filters: *default_filters
      - lint:
          filters: *default_filters
      - deploy_test:
          filters: *default_filters
          requires: [build]
      - pre_deploy_prod:
          filters: &release_filters
            tags:
              only: /^v\d+\.\d+\.\d+.*/
            branches:
              ignore: /.*/
          requires: [test, build, lint, deploy_test]
      - deploy_prod:
          filters: *default_filters # TODO: debug
          requires: [pre_deploy_prod]

executors:
  node-executor:
    docker:
      - image: circleci/node:12-stretch-browsers
    environment:
      NEXT_TELEMETRY_DISABLED: "1"

commands:
  pre_steps:
    steps:
      - checkout
      - restore_cache:
          key: &cache_key v0-dependencies-{{ checksum "yarn.lock" }}
      # Only install dependencies if the cache is failed to restore
      - run: |
          if [ ! -d "./node_modules" ]; then
            yarn install --frozen-lockfile
          fi

  post_steps:
    steps:
      - save_cache:
          paths:
            - node_modules
            - .next/cache # https://err.sh/next.js/no-cache
          key: *cache_key

jobs:
  lint:
    executor: node-executor
    steps:
      - pre_steps
      - run: yarn run lint

  test:
    executor: node-executor
    steps:
      - pre_steps
      - run: |
          echo ${DEV_CONFIG_FIREBASE} > ./config/firebase.json
      - run: |
          export REACT_APP_TESTING=1
          yarn build
          yarn export
      - run: |
          ./scripts/http-server.js > /dev/null &
          yarn run test --coverage
      - run: |
          yarn run coverage
      - post_steps

  build:
    executor: node-executor
    steps:
      - pre_steps
      - run: |
          echo ${PROD_CONFIG_FIREBASE} > ./config/firebase.json
      - run: |
          yarn run build
          yarn run export
      - persist_to_workspace:
          root: ./dist
          paths:
            - .
      - post_steps

  pre_deploy_prod:
    docker:
      - image: python:3.7-stretch
    steps:
      - checkout
      - run: |
          ./scripts/verify-version.py

  deploy_test:
    executor: node-executor
    environment:
      EXTRA_NETLIFY_ARGS: ""
    steps: &deploy_steps
      - pre_steps
      - attach_workspace:
          at: ./dist
      - run: ls -lrth ./dist
      - run: |
          message="Deployment from Circle CI. Ref: $(git rev-parse --abbrev-ref HEAD). Commit: $(git rev-parse --short HEAD)."
          command="yarn netlify deploy --dir ./dist --message '$message' $EXTRA_NETLIFY_ARGS"
          echo $command
          bash -c "$command"

  deploy_prod:
    executor: node-executor
    environment:
      EXTRA_NETLIFY_ARGS: "--prod"
    steps: *deploy_steps
