{
  "name": "main",
  "on": {
    "push": {
      "branches": [
        "**"
      ]
    }
  },
  "env": {
    "NEXT_TELEMETRY_DISABLED": 1
  },
  "jobs": {
    "Build": {
      "runs-on": "ubuntu-18.04",
      "steps": [
        {
          "name": "Checkout code repository",
          "uses": "actions/checkout@v2"
        },
        {
          "name": "Setup node.js",
          "uses": "actions/setup-node@v2",
          "with": {
            "node-version": 14
          }
        },
        {
          "id": "step_cache_deps",
          "name": "Cache dependencies",
          "uses": "actions/cache@v2",
          "with": {
            "path": "node_modules\n*/*/node_modules\n~/.cache/firebase\n~/.cache/ms-playwright\n.yarn/cache\n",
            "key": "${{ runner.os }}-deps-v5-${{ hashFiles('yarn.lock') }}"
          }
        },
        {
          "name": "Install Dependencies",
          "run": "date\nyarn install --immutable\ndate\necho \"[DEBUG] CACHE_HIT: $CACHE_HIT\"\nif [ \"$CACHE_HIT\" != \"true\" ]\nthen\n  echo \"[DEBUG] installing\"\n  yarn run web firebase setup:emulators:firestore\nfi\nls -lrth ~/.cache/firebase/emulators/\n",
          "env": {
            "CACHE_HIT": "${{ steps.step_cache_deps.outputs.cache-hit }}"
          }
        },
        {
          "name": "Configrate firebase",
          "env": {
            "FIREBASE_CLIENT_JSON": "${{ secrets.FIREBASE_CLIENT_JSON }}",
            "FIREBASE_TOKEN": "${{ secrets.FIREBASE_TOKEN }}"
          },
          "run": "echo \"${FIREBASE_CLIENT_JSON}\" > ./packages/web/config/firebase.client.json\nexport FIREBASE_PROJECT_ID=$(scripts/simple_jq.js ./packages/web/config/firebase.client.json .projectId)\nyarn run web firebase use --add $FIREBASE_PROJECT_ID\n"
        },
        {
          "name": "Build website",
          "run": "yarn run build:website\n"
        },
        {
          "name": "Upload dist (web)",
          "uses": "actions/upload-artifact@v2",
          "with": {
            "name": "web_dist",
            "path": "./packages/web/dist"
          }
        },
        {
          "name": "Upload dist (home)",
          "uses": "actions/upload-artifact@v2",
          "with": {
            "name": "home_dist",
            "path": "./packages/home/dist"
          }
        },
        {
          "name": "Update package.json",
          "run": "version=$(jq '.version' ./package.json)\npkgjson=$(jq \".version = $version\" ./packages/electron/package.json)\necho \"$pkgjson\" > ./packages/electron/package.json\ncat ./packages/electron/package.json\n"
        },
        {
          "name": "Build electron",
          "run": "yarn run electron build\n"
        },
        {
          "name": "Clean electron dist",
          "run": "find ./packages/electron/dist -type f\necho \"================ cleaning ================\"\nrm -rf ./packages/electron/dist/mac\nfind ./packages/electron/dist -type f\n"
        },
        {
          "name": "Upload dist (electron)",
          "uses": "actions/upload-artifact@v2",
          "with": {
            "name": "electron_dist",
            "path": "./packages/electron/dist"
          }
        }
      ]
    },
    "Test": {
      "runs-on": "ubuntu-18.04",
      "steps": [
        {
          "name": "Checkout code repository",
          "uses": "actions/checkout@v2"
        }
      ]
    },
    "Lint": {
      "runs-on": "ubuntu-18.04",
      "steps": [
        {
          "name": "Checkout code repository",
          "uses": "actions/checkout@v2"
        }
      ]
    },
    "Preview": {
      "runs-on": "ubuntu-18.04",
      "steps": [
        {
          "name": "Checkout code repository",
          "uses": "actions/checkout@v2"
        },
        {
          "name": "Setup node.js",
          "uses": "actions/setup-node@v2",
          "with": {
            "node-version": 14
          }
        },
        {
          "id": "step_cache_deps",
          "name": "Cache dependencies",
          "uses": "actions/cache@v2",
          "with": {
            "path": "node_modules\n*/*/node_modules\n~/.cache/firebase\n~/.cache/ms-playwright\n.yarn/cache\n",
            "key": "${{ runner.os }}-deps-v5-${{ hashFiles('yarn.lock') }}"
          }
        },
        {
          "name": "Install Dependencies",
          "run": "date\nyarn install --immutable\ndate\necho \"[DEBUG] CACHE_HIT: $CACHE_HIT\"\nif [ \"$CACHE_HIT\" != \"true\" ]\nthen\n  echo \"[DEBUG] installing\"\n  yarn run web firebase setup:emulators:firestore\nfi\nls -lrth ~/.cache/firebase/emulators/\n",
          "env": {
            "CACHE_HIT": "${{ steps.step_cache_deps.outputs.cache-hit }}"
          }
        },
        {
          "name": "Configrate firebase",
          "env": {
            "FIREBASE_CLIENT_JSON": "${{ secrets.FIREBASE_CLIENT_JSON }}",
            "FIREBASE_TOKEN": "${{ secrets.FIREBASE_TOKEN }}"
          },
          "run": "echo \"${FIREBASE_CLIENT_JSON}\" > ./packages/web/config/firebase.client.json\nexport FIREBASE_PROJECT_ID=$(scripts/simple_jq.js ./packages/web/config/firebase.client.json .projectId)\nyarn run web firebase use --add $FIREBASE_PROJECT_ID\n"
        },
        {
          "name": "Build",
          "run": "yarn run build:website\n"
        }
      ]
    },
    "Release": {
      "runs-on": "ubuntu-18.04",
      "needs": [
        "Build",
        "Test",
        "Lint",
        "Preview"
      ],
      "steps": [
        {
          "id": "step_release_please",
          "uses": "GoogleCloudPlatform/release-please-action@v2",
          "with": {
            "token": "${{ secrets.CHANGESET_GITHUB_TOKEN }}",
            "release-type": "node"
          }
        }
      ],
      "outputs": {
        "published": "${{ steps.step_release_please.outputs.release_created }}"
      }
    },
    "Deployment": {
      "runs-on": "ubuntu-18.04",
      "needs": [
        "Release"
      ],
      "steps": [
        {
          "name": "Checkout code repository",
          "uses": "actions/checkout@v2"
        },
        {
          "name": "Setup node.js",
          "uses": "actions/setup-node@v2",
          "with": {
            "node-version": 14
          }
        },
        {
          "name": "Download dist (web)",
          "uses": "actions/download-artifact@v2",
          "with": {
            "name": "web_dist",
            "path": "./packages/web/dist"
          }
        },
        {
          "name": "Download dist (home)",
          "uses": "actions/download-artifact@v2",
          "with": {
            "name": "home_dist",
            "path": "./packages/home/dist"
          }
        },
        {
          "name": "Download dist (electron)",
          "uses": "actions/download-artifact@v2",
          "with": {
            "name": "electron_dist",
            "path": "./packages/electron/dist"
          }
        },
        {
          "name": "Upload @rino.app/electron to GitHub Release",
          "uses": "svenstaro/upload-release-action@v2",
          "with": {
            "repo_token": "${{ secrets.GITHUB_TOKEN }}",
            "file": "./packages/electron/dist/*",
            "tag": "v0.3.2",
            "overwrite": true,
            "file_glob": true
          }
        }
      ]
    }
  }
}
